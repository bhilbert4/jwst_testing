"""
This module contains the validation testing for the JWST Calibration
Pipeline.
"""

__docformat__ = 'reStructuredText'

from astropy.io import fits
import numpy as np
import unittest
import pytest

@pytest.mark.dq_init
class TestDQInitStep:
    """
    The base class for testing the DQInitStep.
    """
    @pytest.fixture
    def refhdu(self, dq_init_hdu):
        CRDS = '/grp/crds/cache/references/jwst/'
        ref_file = CRDS+dq_init_hdu[0].header['R_MASK'][7:]
        return fits.open(ref_file)

    def test_pixeldq_ext_exists(self, dq_init_hdu):
        assert("PIXELDQ" in dq_init_hdu)

    def test_good_pixeldq_propagation(self, dq_init_hdu, refhdu):
        """
        make sure that the values in the reference mask are properly
        translated to values in PIXELDQ
        """

        pixeldq = dq_init_hdu['PIXELDQ'].data
        #find good/bad pixels
        # check that all good and pixels are preserved 
        good = np.where(refhdu['DQ'].data == 0)
        assert np.all(pixeldq[good] == 0)

    def test_dead_pixeldq_dead_propagtion(self, dq_init_hdu, refhdu):
        """
        make sure that the values in the reference mask are properly
        translated to values in PIXELDQ
        """

        pixeldq = dq_init_hdu['PIXELDQ'].data

        # check dead pixels
        dead = np.where(refhdu['DQ'].data == 3)
        assert np.all(pixeldq[dead] == 1025)

    def test_hot_pixeldq_propagation(self, dq_init_hdu, refhdu):
        """
        make sure that the values in the reference mask are properly
        translated to values in PIXELDQ
        """

        pixeldq = dq_init_hdu['PIXELDQ'].data

        # #check hot pixels
        hot = np.where(refhdu['DQ'].data == 5)
        assert np.all(pixeldq[hot] == 2049)

    def test_unreliable_slope_pixeldq_propagation(self, dq_init_hdu, refhdu):
        """
        make sure that the values in the reference mask are properly
        translated to values in PIXELDQ
        """

        pixeldq = dq_init_hdu['PIXELDQ'].data

        # #check unreliable slope
        urs = np.where(refhdu['DQ'].data == 9)
        assert np.all(pixeldq[urs] == 16777217)

    def test_rc_pixeldq_propagation(self, dq_init_hdu, refhdu):
        """
        make sure that the values in the reference mask are properly
        translated to values in PIXELDQ
        """

        pixeldq = dq_init_hdu['PIXELDQ'].data

        # #check RC pixels
        rc = np.where(refhdu['DQ'].data == 17)
        assert np.all(pixeldq[rc] == 16385)

    def test_groupdq_ext_exists(self, dq_init_hdu):
        """
        Checks that the groupdq has been set.
        """
        # if using object from pipeline
        # assert(hasattr(self.dq_init., 'groupdq'))

        # if using fits file generated by strun
        assert("GROUPDQ" in dq_init_hdu)

    def test_groupdq_vals_all_zero(self, dq_init_hdu):
        """
        Checks that the groupdq extension 
        values are all zero after dq_init.
        """
        # if using object from pipeline
        # assert(np.all(self.dq_init.groupdq == 0))

        # if using fits file generated by strun
        assert(np.all(dq_init_hdu["GROUPDQ"].data == 0))


    def test_err_ext_exists(self, dq_init_hdu):
        """
        Check that all err extension values are all zero.
        """

        # if using object from pipeline
        # assert(hasattr(self.dq_init, 'err'))
        # if using fits file generated by strun
        assert("ERR" in dq_init_hdu)

    def test_err_vals_all_zero(self, dq_init_hdu):
        """
        Check that all err extension values are all zero.
        """

        # if using object from pipeline
        # assert(np.all(self.dq_init.pixeldq == 0))

        # if using fits file generated by strun
        assert(np.all(dq_init_hdu["ERR"].data == 0))

@pytest.mark.saturation
class TestSaturationStep:
    """
    The base class for testing the SaturationStep.
    """

    @pytest.fixture
    def refhdu(self, sat_hdu):
        CRDS = '/grp/crds/cache/references/jwst/'
        ref_file = CRDS+sat_hdu[0].header['R_SATURA'][7:]
        return fits.open(ref_file)

    def test_groupdq_vals(self, sat_hdu, refhdu):
        """
        Check that saturated pixels are flagged properly
        """
        # TODO
        assert False

    @pytest.mark.dq_init
    def test_saturation_pixeldq_propagation(self, sat_hdu, refhdu, dq_init_hdu):
        """
        check that proper Data Quality flags are added according to reference
        file.
        """
        bad = np.where(refhdu['DQ'].data == 2)
        assert np.all(dq_init_hdu['PIXELDQ'].data[bad] + 2097152 == sat_hdu['PIXELDQ'].data[bad])
